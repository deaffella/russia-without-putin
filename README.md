# Россия без Путина

<!-- illustration1.png -->

Главная цель проекта создать алгоритм позволяющий с высокой точностью распознавать лицо конкретного человека на видео в реальном времени и при необхоимости скрывать его.

## Установка

Для начала скачиваем репозиторий к себе на компьютер, любым из удобных способов. Например, это можно сделать с помощью команды `git clone`:

```sh
git clone https://github.com/freearhey/russia-without-putin.git
```

Далее заходим в папку с проектом и запускаем установку всех зависимостей:

```sh
# смена директории
cd russia-without-putin

# установка зависимостей
pip install -r requirements.txt
```

Вот и всё, установка закончена!

## Запуск

Чтобы запустить обработку видео трансляции необходимо в скрипт `main.py` через атрибут `--input`  передать лишь ссылку на неё:

```sh
python main.py --input http://uiptv.do.am/1ufc/000000006/playlist.m3u8
```

После чего трансляция автоматически откроется в новом окне:

<!-- screenshot1.png -->

Чтобы сохранить результат обработки у себя на компьютере к вызову скрипта необходимо добавить атрибут `--output` с путем до конечного файла:

```sh
python main.py --input http://uiptv.do.am/1ufc/000000006/playlist.m3u8 --output path/to/output.mp4
```

Вместо прямой трансляции в скрипт можно так же передать и обычное видео:

```sh
python main.py --input examples/video.mp4 --output path/to/output.mp4
```

Прервать запись, как и обработку можно нажатием клавиши 'q'.

## Принцип работы алгоритма

### Сбор данных

Для того чтобы начать создание модели которая бы могла описать те или иные лица нам необходимо сначала найти подходящие "позитивные" и "негативные" примеры. В данном случае "позитивными" являются фотографии лица Путина, а "негативными" фото лиц любых других людей. 

В данном случае для получения большого числа примеров лица Путина в проекте использовались видеозаписи его выступлений, из которых с помощью стороннего скрипта [freearhey/face-extractor](https://github.com/freearhey/face-extractor) автоматически было извлечено 12,308 фото.

![Putin face dataset](.readme/illustration2.png)

В качестве "негативных" примеров использовался [freearhey/face-dataset](https://github.com/freearhey/face-dataset) состоящий из более чем 14,000 фото лиц различных людей. В данной коллекции так же присутствуют фотографии Путина, но перед обработкой они были перенесены в папку с "позитивыными" примерами, в результате чего общее количество "негативных" примеров составило 14,902 фото.

![Non-putin face dataset](.readme/illustration3.png)

В итоге была создана следующая структура данных:

```
dataset/
  putin/
  non-putin/
```

### Создание "обучение" модели

Первым этапом было создание 128-мерныго вектора для каждого лица (так же называемого "embeddings"). Сделано это было с помощью [Deep Neural Network модуля OpenCV](https://docs.opencv.org/master/d2/d58/tutorial_table_of_content_dnn.html) и Torch модели проекта [OpenFace](https://cmusatyalab.github.io/openface/) - [nn4.small2.v1.t7](https://storage.cmusatyalab.org/openface-models/nn4.small2.v1.t7). После чего, полученные вектора были сконвертированы в 1-мерные с использованием метода [numpy.ndarray.flatten](https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.flatten.html) и уже в таком виде использовались далее для тренировки модели.

Далее само "обучение" модели, которая бы математически описывала как именно выглядит Путин, а как другие люди, проходило с использованием алгоритма [Support Vector Machines (SVM)](https://scikit-learn.org/stable/modules/svm.html#support-vector-machines) из библиотеки [scikit-learn](https://scikit-learn.org/stable/). Он как раз позволил автоматически разбить полученные тысячи векторов на две группы: `'putin'` и `'non-putin'`. Ну а полученный  итоге объект был затем сконвертирован в байты с помощью метода [pickle.dumps](https://docs.python.org/3/library/pickle.html#pickle.dumps) и сохранён в файл `models/recognizer`.

Одновременно с этим в отдельный файл `models/label_encoder` были сохранены подписи (лейблы) для каждого вектора, чтобы впоследствии было легче определить чьё именно лицо этот вектор описывает. Перед сохранением все лейблы так же были закодировны с помощью класса [LabelEncoder](https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.LabelEncoder.html) из той же библиотеки [scikit-learn](https://scikit-learn.org/stable/).

Запускается весь выше описанный процесс через скрипт `train_model`, в качестве аргумента в который передается лишь путь до папки с "позитивными" и "негативными" примерами:

```sh
python train_model.py --dataset path/to/dataset
```

### Поиск лиц на видео

Перед тем как начать наконец распознавать лица, нам необходимо сначала найти эти самые лица на видео. Для этого каждое видео проходит через OpenCV класс [VideoCapture](https://docs.opencv.org/2.4/modules/highgui/doc/reading_and_writing_images_and_video.html#videocapture), который позволяет разбить его на отдельные кадры. И уже каждый такой кадр мы пропускаем через библиотеку [cvlib](https://github.com/arunponnusamy/cvlib). В результате чего на выходе мы получаем координаты всех найденных в кадре лиц. 

Под капотом данная библиотека использует уже знакомый вам OpenCV модуль `dnn`, но в этот раз с заранее натренированной Coffe моделью - `res10_300x300_ssd_iter_140000`. И да, эта же библиотека использовался для извлечения фотографий лица Путина и создания коллекции [freearhey/face-dataset](https://github.com/freearhey/face-dataset).

### Распознавание найденных лиц

Ну и теперь имея не только модель описывающую как лицо Путина, так и лица других людей, а так же определив где в кадре находится неизестное нам лицо мы можем начать их сравнивать.

Для этого мы вновь создаем 128-мерный вектор, но в этот раз для нашего неизвестного лица. Делается это так же с помощью Torch модели, что и в процессе "обучения" - [nn4.small2.v1.t7](https://storage.cmusatyalab.org/openface-models/nn4.small2.v1.t7).

Далее уже полученный вектор на необходимо пропустить через созданный нами ранее `models/recognizer`. Чтобы загрузить его обратно мы используем в данном случае метод [pickle.loads](https://docs.python.org/3/library/pickle.html#pickle.loads). Уже после чего передаем вектор в метод [predict_proba()](https://scikit-learn.org/stable/modules/generated/sklearn.svm.libsvm.predict_proba.html) нашей модели.

На выходе каждый раз мы должны получать массив содержащий, в данном случае, два числа. Первое - вероятность от 0 до 1 что найденное лицо в кадре не принадлежит Путину, а второе - что принадлежит.

На же в итоге остается лишь выбрать из этих чисел большее и подсмотреть в `models/label_encoder` какой это должен быть лейбл.

Ну вот, в принципе, и всё. Далее кадр просто выводится на экран и, если лицо принадлежит Путину, на его месте рисуется черный прямоугольник.

## В планах

- добавить распознавание текста
- добавить распознавание звука
- ускорить обработку отдельного кадра
- увеличить точность распознавания
- уменьшить количество "false positive" результатов
- запустить ретрансляцию обработанного видео

## Как помочь?

Если вы нашли какую-то ошибку или у вас есть идея как можно улучшить данный алгоритм, можете написать об этом [сюда](https://github.com/freearhey/russia-without-putin/issues).

## Лицензия

[MIT](LICENSE)